<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<title>MyAIToolBox – Audio Extractor & Trimmer</title>
<style>
body {
    margin:0;
    font-family:system-ui, sans-serif;
    background:linear-gradient(135deg,#0b66b2,#0b66b2,#cfefff);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:30px;
}
.app {
    width:100%;
    max-width:760px;
    background:#ffffffdd;
    backdrop-filter:blur(5px);
    border-radius:18px;
    padding:22px;
    box-shadow:0 8px 28px rgba(0,0,0,0.25);
}
h2 {margin-top:0;}
.field {margin-bottom:14px;}
label {font-size:.85rem;font-weight:600;display:block;margin-bottom:4px;}
input[type=file], select {
    width:100%;padding:8px;
    border-radius:8px;border:1px solid #999;
}
button {
    padding:10px 16px;
    border:none;
    border-radius:8px;
    background:#0b66b2;
    color:white;
    font-weight:600;
    cursor:pointer;
    margin-right:10px;
}
button:disabled {opacity:.55;cursor:not-allowed;}
#audioWaveform {
    width:100%;
    height:60px;
    margin-top:12px;
    border:1px solid #b8d9ff;
    border-radius:6px;
    background:#eef7ff;
    position:relative;
}
.waveCanvas {
    position:absolute; top:0; left:0;
    width:100%; height:100%;
}
.handle {
    position:absolute; top:0; width:6px; background:#0b66b2; cursor:ew-resize;
    height:100%;
}
#progressBox {
    margin-top:10px;
    height:8px;
    background:#e3e3e3;
    border-radius:5px;
    overflow:hidden;
    display:none;
}
#progressBar {
    height:100%;
    width:0%;
    background:#0b66b2;
    transition:width .2s linear;
}
.audio-box {
    background:#eef7ff;
    border:1px solid #b8d9ff;
    padding:12px;
    border-radius:8px;
    margin-top:12px;
    display:none;
}
audio {width:100%;margin-top:6px;}
</style>
</head>
<body>

<div class="app">
<h2>MyAIToolBox – Audio Extractor & Trimmer</h2>

<div class="field">
    <label>Select Video File</label>
    <input type="file" id="videoFile" accept="video/*">
</div>

<div class="field">
    <label>Bitrate (kbps)</label>
    <select id="bitrateSelect">
        <option value="128">128 kbps</option>
        <option value="192" selected>192 kbps</option>
        <option value="256">256 kbps</option>
        <option value="320">320 kbps</option>
    </select>
</div>

<button id="extractBtn" disabled>Extract Audio</button> <button id="downloadFullWAV" disabled>Download Full WAV</button>

<div id="audioWaveform">
    <canvas class="waveCanvas" id="waveCanvas"></canvas>
    <div class="handle" id="leftHandle"></div>
    <div class="handle" id="rightHandle" style="right:0;"></div>
</div>

<button id="trimBtn" disabled>Trim & Download WAV</button> <button id="resetBtn">Reset</button>

<div id="progressBox"><div id="progressBar"></div></div>

<div class="audio-box" id="previewBox">
    <div><strong>Preview Audio:</strong></div>
    <audio id="audioPreview" controls></audio>
</div>
</div>

<script>
let videoFile, audioBuffer;
const videoInput = document.getElementById("videoFile");
const extractBtn = document.getElementById("extractBtn");
const downloadFullWAV = document.getElementById("downloadFullWAV");
const trimBtn = document.getElementById("trimBtn");
const resetBtn = document.getElementById("resetBtn");
const audioPreview = document.getElementById("audioPreview");
const leftHandle = document.getElementById("leftHandle");
const rightHandle = document.getElementById("rightHandle");
const waveform = document.getElementById("audioWaveform");
const canvas = document.getElementById("waveCanvas");
const ctx = canvas.getContext("2d");
let drag = null;

videoInput.addEventListener("change", e => {
    if(!e.target.files.length) return;
    videoFile = e.target.files[0];
    extractBtn.disabled = false;
});

function setProgress(p) {
    const box = document.getElementById("progressBox");
    const bar = document.getElementById("progressBar");
    box.style.display = "block";
    bar.style.width = p + "%";
}

extractBtn.onclick = async () => {
    if(!videoFile) return;
    setProgress(5);
    const arrayBuf = await videoFile.arrayBuffer();
    setProgress(25);
    const audioCtx = new AudioContext();
    audioBuffer = await audioCtx.decodeAudioData(arrayBuf);
    setProgress(70);
    audioPreview.src = URL.createObjectURL(bufferToWav(audioBuffer));
    drawWaveform(audioBuffer);
    document.getElementById("previewBox").style.display = "block";
    downloadFullWAV.disabled = false;
    trimBtn.disabled = false;
    setProgress(100);
    setTimeout(()=>document.getElementById("progressBox").style.display="none",700);
};

function drawWaveform(buffer) {
    canvas.width = waveform.clientWidth;
    canvas.height = waveform.clientHeight;
    const data = buffer.getChannelData(0);
    const step = Math.ceil(data.length / canvas.width);
    const amp = canvas.height / 2;
    ctx.fillStyle = "#eef7ff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle = "#0b66b2";
    ctx.beginPath();
    for(let i=0;i<canvas.width;i++){
        let min=1.0,max=-1.0;
        for(let j=0;j<step;j++){
            const datum = data[(i*step)+j];
            if(datum<min) min=datum;
            if(datum>max) max=datum;
        }
        ctx.moveTo(i,(1+min)*amp);
        ctx.lineTo(i,(1+max)*amp);
    }
    ctx.stroke();
}

downloadFullWAV.onclick = () => {
    downloadBlob(bufferToWav(audioBuffer), "audio_full.wav");
};

trimBtn.onclick = () => {
    const waveformWidth = waveform.offsetWidth;
    const startRatio = leftHandle.offsetLeft / waveformWidth;
    const endRatio = (waveformWidth - rightHandle.offsetLeft - rightHandle.offsetWidth)/ waveformWidth;
    const start = startRatio * audioBuffer.duration;
    const end = endRatio * audioBuffer.duration;
    const trimmed = trimAudio(audioBuffer, start, end);
    audioPreview.src = URL.createObjectURL(bufferToWav(trimmed));
    downloadBlob(bufferToWav(trimmed), "audio_trimmed.wav");
};

function trimAudio(buffer, start, end) {
    start = Math.max(0, start);
    end = Math.min(buffer.duration, end);
    const frameStart = Math.floor(start*buffer.sampleRate);
    const frameEnd = Math.floor(end*buffer.sampleRate);
    const length = frameEnd - frameStart;
    const out = new AudioContext().createBuffer(buffer.numberOfChannels, length, buffer.sampleRate);
    for(let c=0;c<buffer.numberOfChannels;c++){
        out.getChannelData(c).set(buffer.getChannelData(c).slice(frameStart, frameEnd));
    }
    return out;
}

function bufferToWav(abuffer){
    const numOfChan = abuffer.numberOfChannels,
    length = abuffer.length*numOfChan*2+44,
    buffer=new ArrayBuffer(length),
    view=new DataView(buffer);
    let channels=[], pos=0;
    writeUTFBytes(view,pos,'RIFF'); pos+=4;
    view.setUint32(pos,length-8,true); pos+=4;
    writeUTFBytes(view,pos,'WAVE'); pos+=4;
    writeUTFBytes(view,pos,'fmt '); pos+=4;
    view.setUint32(pos,16,true); pos+=4;
    view.setUint16(pos,1,true); pos+=2;
    view.setUint16(pos,numOfChan,true); pos+=2;
    view.setUint32(pos,abuffer.sampleRate,true); pos+=4;
    view.setUint32(pos,abuffer.sampleRate*numOfChan*2,true); pos+=4;
    view.setUint16(pos,numOfChan*2,true); pos+=2;
    view.setUint16(pos,16,true); pos+=2;
    writeUTFBytes(view,pos,'data'); pos+=4;
    view.setUint32(pos,length-pos-4,true); pos+=4;
    for(let i=0;i<numOfChan;i++) channels.push(abuffer.getChannelData(i));
    let offset=0;
    while(pos<length){
        for(let i=0;i<numOfChan;i++){
            let sample=Math.max(-1,Math.min(1,channels[i][offset]));
            view.setInt16(pos,sample<0?sample*32768:sample*32767,true);
            pos+=2;
        }
        offset++;
    }
    return new Blob([buffer],{type:"audio/wav"});
}

function writeUTFBytes(view,offset,string){
    for(let i=0;i<string.length;i++){
        view.setUint8(offset+i,string.charCodeAt(i));
    }
}

function downloadBlob(blob,name){
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=name;
    a.click();
}

/* Drag handles */
[leftHandle,rightHandle].forEach(handle=>{
    handle.addEventListener("mousedown",e=>drag=handle);
});
document.addEventListener("mouseup",()=>drag=null);
document.addEventListener("mousemove",e=>{
    if(!drag) return;
    const rect=waveform.getBoundingClientRect();
    let x=e.clientX-rect.left;
    x=Math.max(0,Math.min(rect.width, x));
    if(drag===leftHandle && x<rightHandle.offsetLeft){
        drag.style.left=x+"px";
    }
    if(drag===rightHandle && x>leftHandle.offsetLeft){
        drag.style.left=x+"px";
    }
});

resetBtn.onclick=()=>{
    videoInput.value="";
    audioPreview.src="";
    document.getElementById("previewBox").style.display="none";
    extractBtn.disabled=true;
    downloadFullWAV.disabled=true;
    trimBtn.disabled=true;
    leftHandle.style.left="0px";
    rightHandle.style.left=(waveform.offsetWidth-6)+"px";
    ctx.clearRect(0,0,canvas.width,canvas.height);
};
</script>

</body>
</html>
